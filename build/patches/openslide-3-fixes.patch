This file is part of MXE. See LICENSE.md for licensing information.

Contains ad hoc patches for cross building.

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Sat, 2 June 2018 14:20:00 +0200
Subject: [PATCH 1/2] Windows fixes

- Fix compile errors with labeled statements named `OUT`.
- The `host_os` and `build_os` variables may contain the
  `.shared` or `.static` suffix.

diff --git a/configure.ac b/configure.ac
index 1111111..2222222 100644
--- a/configure.ac
+++ b/configure.ac
@@ -25,7 +25,10 @@ LT_INIT([win32-dll disable-static])
 LT_LANG([Windows Resource])
 
 # Windows resources and manifest
-AM_CONDITIONAL([WINDOWS_RESOURCES], [test $host_os = mingw32])
+AS_CASE([$host_os],
+  [mingw32*], [AM_CONDITIONAL([WINDOWS_RESOURCES], [true])],
+  [AM_CONDITIONAL([WINDOWS_RESOURCES], [false])]
+)
 WINDOWS_VERSIONINFO=$(echo "${VERSION}.0.0.0" | cut -f1-4 -d. | tr . ,)
 AC_SUBST([WINDOWS_VERSIONINFO])
 
@@ -96,7 +99,7 @@ CFLAGS="$saved_CFLAGS"
 # CLOEXEC
 AC_MSG_CHECKING([fopen() close-on-exec flag])
 AS_CASE([$host_os],
-  [mingw32], [
+  [mingw32*], [
     # Assume that if we're building for Windows, we want to pass N to fopen().
     AC_MSG_RESULT([N])
     AC_DEFINE([FOPEN_CLOEXEC_FLAG], ["N"], [Set to the fopen() flag string that sets FD_CLOEXEC, or an empty string if not supported.])
@@ -160,13 +163,16 @@ AC_LINK_IFELSE([
 
 # The test driver has special support for testing Windows builds from Cygwin
 AC_MSG_CHECKING([whether to cross-test from Cygwin])
-if test "$host_os" = "mingw32" -a "$build_os" = "cygwin"; then
-  AC_MSG_RESULT([yes])
-  CYGWIN_CROSS_TEST=yes
-else
-  AC_MSG_RESULT([no])
-  CYGWIN_CROSS_TEST=""
-fi
+case ${host_os}+${build_os} in
+  mingw32*+cygwin*)
+    AC_MSG_RESULT([yes])
+    CYGWIN_CROSS_TEST=yes
+    ;;
+  *)
+    AC_MSG_RESULT([no])
+    CYGWIN_CROSS_TEST=""
+    ;;
+esac
 AC_SUBST([CYGWIN_CROSS_TEST])
 AM_CONDITIONAL([CYGWIN_CROSS_TEST], [test -n "$CYGWIN_CROSS_TEST"])
 
@@ -204,7 +210,19 @@ PKG_CHECK_VAR(GLIB2_DATADIR, [gio-2.0], datadir)
 WARN_CFLAGS="-Wall -Wextra -Wstrict-prototypes -Wmissing-prototypes -Wmissing-declarations -Wnested-externs"
 AC_SUBST([WARN_CFLAGS])
 
-AC_SUBST(AM_CFLAGS, ['$(WARN_CFLAGS) $(CFLAG_VISIBILITY) -DG_DISABLE_SINGLE_INCLUDES -DGLIB_VERSION_MIN_REQUIRED=GLIB_VERSION_2_56 -DGLIB_VERSION_MAX_ALLOWED=GLIB_VERSION_MIN_REQUIRED -fno-common'])
+# The CFLAG_NO_PSEUDO_MODIFIERS variable prevents Windows.h from
+# defining IN or OUT.
+case "$host_os" in
+  mingw32*)
+    CFLAG_NO_PSEUDO_MODIFIERS=-D_NO_W32_PSEUDO_MODIFIERS
+    ;;
+  *)
+    CFLAG_NO_PSEUDO_MODIFIERS=""
+    ;;
+esac
+AC_SUBST([CFLAG_NO_PSEUDO_MODIFIERS])
+
+AC_SUBST(AM_CFLAGS, ['$(WARN_CFLAGS) $(CFLAG_VISIBILITY) $(CFLAG_NO_PSEUDO_MODIFIERS) -DG_DISABLE_SINGLE_INCLUDES -DGLIB_VERSION_MIN_REQUIRED=GLIB_VERSION_2_56 -DGLIB_VERSION_MAX_ALLOWED=GLIB_VERSION_MIN_REQUIRED -fno-common'])
 
 AC_SUBST(FEATURE_FLAGS)
 
From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Wed, 25 Dec 2019 18:00:00 +0100
Subject: [PATCH 2/2] Ensure that the RT_MANIFEST value is quoted

GNU windres does not treat hyphens as separators. However,
llvm-rc or MSVC's rc.exe treats them as separators, causing
a build error on these toolchains if the value is not quoted.

See: https://github.com/mstorsjo/llvm-mingw/issues/67

diff --git a/src/openslide-dll.rc.in b/src/openslide-dll.rc.in
index 1111111..2222222 100644
--- a/src/openslide-dll.rc.in
+++ b/src/openslide-dll.rc.in
@@ -1,7 +1,7 @@
 #include "winuser.h"
 #include "winver.h"
 
-2 RT_MANIFEST openslide-dll.manifest
+2 RT_MANIFEST "openslide-dll.manifest"
 
 1 VERSIONINFO
 FILEVERSION @WINDOWS_VERSIONINFO@
