This file is part of MXE. See LICENSE.md for licensing information.

Contains ad hoc patches for cross building.

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Thu, 28 Mar 2024 18:29:25 +0100
Subject: [PATCH 1/5] Ignore any errors from native-static-libs query

It will not properly work with `-Zbuild-std`.

diff --git a/meson.build b/meson.build
index 1111111..2222222 100644
--- a/meson.build
+++ b/meson.build
@@ -317,13 +317,8 @@ if host_system == 'windows'
   native_libs = run_command(
     rustc_query_native_static_libs_args,
     capture: true,
-    check: true
   )
 
-  if native_libs.stderr() != ''
-    error(native_libs.stderr())
-  endif
-
   foreach i: native_libs.stdout().split()
     if i != 'msvcrt'
       private_dependencies += cc.find_library(i, required: get_option('default_library') != 'shared')

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Fri, 7 Jul 2023 18:41:29 +0200
Subject: [PATCH 2/5] Disable PDF/PostScript features in cairo-rs

We build Cairo with `-Dzlib=disabled`, which implicitly disables
these surface backends.

diff --git a/librsvg-c/Cargo.toml b/librsvg-c/Cargo.toml
index 1111111..2222222 100644
--- a/librsvg-c/Cargo.toml
+++ b/librsvg-c/Cargo.toml
@@ -10,7 +10,7 @@ edition.workspace = true
 rust-version.workspace = true
 
 [dependencies]
-cairo-rs = { version = "0.19", features=["v1_16", "png", "pdf", "ps", "svg"] }
+cairo-rs = { version = "0.19", features=["v1_16", "png", "svg"] }
 cast = "0.3.0"
 float-cmp = "0.9.0"
 gdk-pixbuf = { version = "0.19", optional = true }
diff --git a/rsvg/Cargo.toml b/rsvg/Cargo.toml
index 1111111..2222222 100644
--- a/rsvg/Cargo.toml
+++ b/rsvg/Cargo.toml
@@ -48,7 +48,7 @@ name = "rsvg"
 [dependencies]
 # Keep these in sync with respect to the cairo-rs version:
 #   src/lib.rs - toplevel example in the docs
-cairo-rs = { version = "0.19", features=["v1_16", "png", "pdf", "ps", "svg"] }
+cairo-rs = { version = "0.19", features=["v1_16", "png", "svg"] }
 cast = "0.3.0"
 cssparser = "~0.31"
 data-url = "0.3.0"

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Sun, 21 Apr 2024 09:40:14 +0200
Subject: [PATCH 3/5] meson: Fix installation of the static library

When building with `--default-library=static`, this ensures that
`librsvg-2.a` is installed rather than `librsvg_2.a`, which helps
pkg-config to find `-lrsvg-2`.

Upstream-Status: Submitted [https://gitlab.gnome.org/GNOME/librsvg/-/merge_requests/966]

diff --git a/rsvg/meson.build b/rsvg/meson.build
index 1111111..2222222 100644
--- a/rsvg/meson.build
+++ b/rsvg/meson.build
@@ -99,8 +99,6 @@ rust_artifacts = custom_target(
     '--extension', ext_static,
   ] + avif_feature_args
     + pixbuf_feature_args,
-  install: get_option('default_library') == 'static',
-  install_dir: get_option('libdir'),
 )
 
 librsvg_c_lib = rust_artifacts[0]
@@ -259,7 +257,9 @@ if get_option('default_library') in ['static', 'both']
       'import os; import sys; import shutil; shutil.copy(sys.argv[1], sys.argv[2])',
       '@INPUT0@',
       '@OUTPUT0@'
-    ]
+    ],
+    install: true,
+    install_dir: get_option('libdir'),
   )
 
   librsvg_rust_dep = librsvg_lib

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Sun, 21 Apr 2024 10:01:40 +0200
Subject: [PATCH 4/5] Disallow unsupported image formats from image-rs

Resolves: https://gitlab.gnome.org/GNOME/librsvg/-/issues/1061.

Upstream-Status: Submitted [https://gitlab.gnome.org/GNOME/librsvg/-/merge_requests/967]

diff --git a/Cargo.lock b/Cargo.lock
index 1111111..2222222 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -149,12 +149,6 @@ version = "0.6.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "349f9b6a179ed607305526ca489b34ad0a41aed5f7980fa90eb03160b69598fb"
 
-[[package]]
-name = "bit_field"
-version = "0.10.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "dc827186963e592360843fb5ba4b973e145841266c1357f7180c43526f2e5b61"
-
 [[package]]
 name = "bitflags"
 version = "1.3.2"
@@ -600,22 +594,6 @@ dependencies = [
  "windows-sys 0.52.0",
 ]
 
-[[package]]
-name = "exr"
-version = "1.72.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "887d93f60543e9a9362ef8a21beedd0a833c5d9610e18c67abe15a5963dcb1a4"
-dependencies = [
- "bit_field",
- "flume",
- "half",
- "lebe",
- "miniz_oxide",
- "rayon-core",
- "smallvec",
- "zune-inflate",
-]
-
 [[package]]
 name = "fallible_collections"
 version = "0.4.9"
@@ -659,15 +637,6 @@ dependencies = [
  "num-traits",
 ]
 
-[[package]]
-name = "flume"
-version = "0.11.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "55ac459de2512911e4b674ce33cf20befaba382d05b62b008afc1c8b57cbf181"
-dependencies = [
- "spin",
-]
-
 [[package]]
 name = "fnv"
 version = "1.0.7"
@@ -803,9 +772,9 @@ dependencies = [
 
 [[package]]
 name = "gif"
-version = "0.12.0"
+version = "0.13.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "80792593675e051cf94a4b111980da2ba60d4a83e43e0048c5693baab3977045"
+checksum = "3fb2d69b19215e18bb912fa30f7ce15846e301408695e44e0ef719f1da9e19f2"
 dependencies = [
  "color_quant",
  "weezl",
@@ -970,23 +939,20 @@ dependencies = [
 
 [[package]]
 name = "image"
-version = "0.24.8"
+version = "0.24.9"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "034bbe799d1909622a74d1193aa50147769440040ff36cb2baa947609b0a4e23"
+checksum = "5690139d2f55868e080017335e4b94cb7414274c74f1669c84fb5feba2c9f69d"
 dependencies = [
  "bytemuck",
  "byteorder",
  "color_quant",
  "dav1d",
  "dcv-color-primitives",
- "exr",
  "gif",
  "jpeg-decoder",
  "mp4parse",
  "num-traits",
  "png",
- "qoi",
- "tiff",
 ]
 
 [[package]]
@@ -1039,9 +1005,6 @@ name = "jpeg-decoder"
 version = "0.3.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "f5d4a7da358eff58addd2877a45865158f0d78c911d43a5784ceb7bbf52833b0"
-dependencies = [
- "rayon",
-]
 
 [[package]]
 name = "js-sys"
@@ -1064,12 +1027,6 @@ version = "1.4.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "e2abad23fbc42b3700f2f279844dc832adb2b2eb069b2df918f455c4e18cc646"
 
-[[package]]
-name = "lebe"
-version = "0.5.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "03087c2bad5e1034e8cace5926dec053fb3790248370865f5117a7d0213354c8"
-
 [[package]]
 name = "libc"
 version = "0.2.153"
@@ -1758,15 +1715,6 @@ dependencies = [
  "unarray",
 ]
 
-[[package]]
-name = "qoi"
-version = "0.4.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "7f6d64c71eb498fe9eae14ce4ec935c555749aef511cca85b5568910d6e48001"
-dependencies = [
- "bytemuck",
-]
-
 [[package]]
 name = "quick-error"
 version = "1.2.3"
@@ -2105,15 +2053,6 @@ version = "1.13.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "e6ecd384b10a64542d77071bd64bd7b231f4ed5940fba55e98c3de13824cf3d7"
 
-[[package]]
-name = "spin"
-version = "0.9.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "6980e8d7511241f8acf4aebddbb1ff938df5eebe98691418c4468d0b72a96a67"
-dependencies = [
- "lock_api",
-]
-
 [[package]]
 name = "stable_deref_trait"
 version = "1.2.0"
@@ -2248,17 +2187,6 @@ dependencies = [
  "syn 2.0.48",
 ]
 
-[[package]]
-name = "tiff"
-version = "0.9.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ba1310fcea54c6a9a4fd1aad794ecc02c31682f6bfbecdf460bf19533eed1e3e"
-dependencies = [
- "flate2",
- "jpeg-decoder",
- "weezl",
-]
-
 [[package]]
 name = "time"
 version = "0.3.34"
@@ -2756,12 +2684,3 @@ dependencies = [
  "quote",
  "syn 2.0.48",
 ]
-
-[[package]]
-name = "zune-inflate"
-version = "0.2.54"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "73ab332fe2f6680068f3582b16a24f90ad7096d5d39b974d1c0aff0125116f02"
-dependencies = [
- "simd-adler32",
-]
diff --git a/rsvg/Cargo.toml b/rsvg/Cargo.toml
index 1111111..2222222 100644
--- a/rsvg/Cargo.toml
+++ b/rsvg/Cargo.toml
@@ -56,7 +56,7 @@ encoding_rs = "0.8.32"
 float-cmp = "0.9.0"
 gio = "0.19"
 glib = "0.19"
-image = "0.24.7"
+image = { version = "0.24.9", default-features = false, features = ["jpeg", "png", "gif", "webp"] }
 itertools = "0.12.0"
 language-tags = "0.3.1"
 libc = "0.2"

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Sun, 21 Apr 2024 12:01:02 +0200
Subject: [PATCH 5/5] Disallow GIF and WebP embedded in SVG images

Upstream-Status: Inappropriate [disable feature]
This is specific to libvips' prebuilt binaries.

diff --git a/Cargo.lock b/Cargo.lock
index 1111111..2222222 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -770,16 +770,6 @@ dependencies = [
  "wasi",
 ]
 
-[[package]]
-name = "gif"
-version = "0.13.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "3fb2d69b19215e18bb912fa30f7ce15846e301408695e44e0ef719f1da9e19f2"
-dependencies = [
- "color_quant",
- "weezl",
-]
-
 [[package]]
 name = "gio"
 version = "0.19.0"
@@ -948,7 +938,6 @@ dependencies = [
  "color_quant",
  "dav1d",
  "dcv-color-primitives",
- "gif",
  "jpeg-decoder",
  "mp4parse",
  "num-traits",
diff --git a/rsvg/Cargo.toml b/rsvg/Cargo.toml
index 1111111..2222222 100644
--- a/rsvg/Cargo.toml
+++ b/rsvg/Cargo.toml
@@ -56,7 +56,7 @@ encoding_rs = "0.8.32"
 float-cmp = "0.9.0"
 gio = "0.19"
 glib = "0.19"
-image = { version = "0.24.9", default-features = false, features = ["jpeg", "png", "gif", "webp"] }
+image = { version = "0.24.9", default-features = false, features = ["jpeg", "png"] }
 itertools = "0.12.0"
 language-tags = "0.3.1"
 libc = "0.2"
