From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Mon, 8 Dec 2025 19:41:56 +0100
Subject: [PATCH 1/2] Allow disabling the `HWY_AVX10_2` target

Upstream-Status: Inappropriate [other]
Requires Highway 1.3.0 or later, will fail on earlier versions with:
```
error: use of undeclared identifier 'HWY_AVX10_2'
```

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 1111111..2222222 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -132,8 +132,8 @@ else()
   set(ENABLE_SKCMS_DEFAULT YES)
 endif()
 
-set(JPEGXL_HWY_TARGETS AVX2 AVX3 AVX3_DL AVX3_SPR AVX3_ZEN4 EMU128 NEON NEON_BF16 NEON_WITHOUT_AES PPC10 PPC8 PPC9 RVV SCALAR SSE2 SSE4 SSSE3 SVE SVE_256 SVE2 SVE2_128 WASM WASM_EMU256 Z14 Z15)
-set(JPEGXL_HWY_TARGETS_OFF_BY_DEFAULT AVX3 AVX3_SPR AVX3_ZEN4 RVV SSSE3 SVE_256)
+set(JPEGXL_HWY_TARGETS AVX2 AVX3 AVX3_DL AVX3_SPR AVX3_ZEN4 AVX10_2 EMU128 NEON NEON_BF16 NEON_WITHOUT_AES PPC10 PPC8 PPC9 RVV SCALAR SSE2 SSE4 SSSE3 SVE SVE_256 SVE2 SVE2_128 WASM WASM_EMU256 Z14 Z15)
+set(JPEGXL_HWY_TARGETS_OFF_BY_DEFAULT AVX3 AVX3_SPR AVX3_ZEN4 AVX10_2 RVV SSSE3 SVE_256)
 if (NOT CXX_SVE_SUPPORTED)
   list(APPEND JPEGXL_HWY_TARGETS_OFF_BY_DEFAULT SVE SVE2 SVE_256 SVE2_128)
 endif()

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kleis Auke Wolthuizen <github@kleisauke.nl>
Date: Sun, 14 Dec 2025 15:50:37 +0100
Subject: [PATCH 2/2] Avoid dllexport when built as static library on Win32

The `GenerateExportHeader` module assumes it's acting on a shared
library. When libjxl is built as a static library, we must define
`JXL*_STATIC_DEFINE` explicitly to disable symbol export.

Without this, symbols from a statically built libjxl may be
incorrectly exported as part of the ABI of any dynamic library that
links against it.

A CMake block attempting to handle this already existed, but it was
a no-op because the internal objects had already been built.

Upstream-Status: Submitted [https://github.com/libjxl/libjxl/pull/4540]

diff --git a/lib/jxl.cmake b/lib/jxl.cmake
index 1111111..2222222 100644
--- a/lib/jxl.cmake
+++ b/lib/jxl.cmake
@@ -97,6 +97,8 @@ target_include_directories(jxl_base BEFORE INTERFACE
   ${PROJECT_SOURCE_DIR}
   ${JXL_HWY_INCLUDE_DIRS}
 )
+target_compile_definitions(jxl_base INTERFACE
+  "$<$<NOT:$<BOOL:${BUILD_SHARED_LIBS}>>:JXL_STATIC_DEFINE>")
 
 # On android, link with log to use android-related log functions.
 if(CMAKE_SYSTEM_NAME STREQUAL "Android")
@@ -242,11 +244,6 @@ else()
   list(REMOVE_ITEM CMAKE_REQUIRED_LINK_OPTIONS ${LINKER_EXCLUDE_LIBS_FLAG})
 endif()
 
-if(NOT BUILD_SHARED_LIBS)
-  target_compile_definitions(jxl PUBLIC -DJXL_STATIC_DEFINE)
-  target_compile_definitions(jxl_dec PUBLIC -DJXL_STATIC_DEFINE)
-endif()
-
 # Add a jxl.version file as a version script to tag symbols with the
 # appropriate version number. This script is also used to limit what's exposed
 # in the shared library from the static dependencies bundled here.
diff --git a/lib/jxl_cms.cmake b/lib/jxl_cms.cmake
index 1111111..2222222 100644
--- a/lib/jxl_cms.cmake
+++ b/lib/jxl_cms.cmake
@@ -23,6 +23,8 @@ target_include_directories(jxl_cms PRIVATE
 generate_export_header(jxl_cms
   BASE_NAME JXL_CMS
   EXPORT_FILE_NAME include/jxl/jxl_cms_export.h)
+target_compile_definitions(jxl_cms PUBLIC
+  "$<$<NOT:$<BOOL:${BUILD_SHARED_LIBS}>>:JXL_CMS_STATIC_DEFINE>")
 target_include_directories(jxl_cms BEFORE PUBLIC
   "$<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}>")
 
diff --git a/lib/jxl_threads.cmake b/lib/jxl_threads.cmake
index 1111111..2222222 100644
--- a/lib/jxl_threads.cmake
+++ b/lib/jxl_threads.cmake
@@ -59,6 +59,8 @@ target_compile_definitions(jxl_threads
 generate_export_header(jxl_threads
   BASE_NAME JXL_THREADS
   EXPORT_FILE_NAME include/jxl/jxl_threads_export.h)
+target_compile_definitions(jxl_threads PUBLIC
+  "$<$<NOT:$<BOOL:${BUILD_SHARED_LIBS}>>:JXL_THREADS_STATIC_DEFINE>")
 # Place all public headers in a single directory.
 foreach(path ${JPEGXL_INTERNAL_THREADS_PUBLIC_HEADERS})
   configure_file(
